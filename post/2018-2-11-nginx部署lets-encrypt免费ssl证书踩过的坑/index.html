<!DOCTYPE html>
<html lang="zh-an">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net" />
  <link rel="dns-prefetch" href="//www.google-analytics.com" />
  
  <link rel="canonical" href="/post/2018-2-11-nginx%E9%83%A8%E7%BD%B2lets-encrypt%E5%85%8D%E8%B4%B9ssl%E8%AF%81%E4%B9%A6%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91/" />
  
  <meta name="description" content="Nginx部署Let&#39;s Encrypt免费SSL证书踩过的坑">
  
  <title>
	  
	    Nginx部署Let&#39;s Encrypt免费SSL证书踩过的坑 | Auuu Nya Blog
	  
  </title>

  
  <meta property="og:site_name" content="Auuu Nya Blog" />
  <meta property="og:locale" content="zh-an" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Nginx部署Let&#39;s Encrypt免费SSL证书踩过的坑" />
  <meta property="og:description" content="Nginx部署Let&#39;s Encrypt免费SSL证书踩过的坑 | Auuu Nya Blog" />
  <meta property="og:url" content="/post/2018-2-11-nginx%E9%83%A8%E7%BD%B2lets-encrypt%E5%85%8D%E8%B4%B9ssl%E8%AF%81%E4%B9%A6%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91/" />
  

  <link rel="stylesheet" href="//cdn.jsdelivr.net/uikit/2.27.2/css/uikit.min.css" />
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github.min.css" />
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
	<div class="uk-block uk-block-large uk-block-muted">
		<div class="uk-container uk-container-center">
			<div class="uk-grid">
				<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
				<div class="uk-width-large-8-10 uk-width-medium-1-1 uk-width-small-1-1">
          <div id="header" class="clearfix">
            <div class="uk-float-left">
              <h2><a href="/">Auuu Nya Blog</a></h2>
            </div>
            <div class="uk-float-right">
              <a href="/" class="uk-button">Home</a>
            </div>
          </div>
				</div>
				<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
			</div>
		</div>
	</div>

<div class="uk-block uk-block-default">
	<div class="uk-container uk-container-center">
		<div class="uk-grid">
			<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
			<div class="uk-width-large-8-10 uk-width-medium-1-1 uk-width-small-1-1">
				<article class="uk-article">
					<h1 class="uk-article-title" style="font-size: 23px;">
						Nginx部署Let&#39;s Encrypt免费SSL证书踩过的坑
					</h1>
					
					<p class="uk-article-meta">Posted on Sun, Feb 11, 2018 |  <a href="http://mu1er.github.io/tags/ssl" class="uk-button uk-button-mini">#SSL</a></p>

          
					<h3 id="申请let-s-encrypt永久免费ssl证书">申请Let&rsquo;s Encrypt永久免费SSL证书</h3>

<h4 id="let-s-encrypt简介">Let&rsquo;s Encrypt简介</h4>

<p><a href="https://link.jianshu.com?t=https%3A%2F%2Fletsencrypt.org%2F">Let&rsquo;s Encrypt</a>公共且免费SSL的项目</p>

<p><a href="https://link.jianshu.com?t=https%3A%2F%2Fletsencrypt.org%2F">Let&rsquo;s Encrypt免费SSL</a>支持包括FireFox、Chrome在内的主流浏览器的兼容和支持，虽然目前是公测阶段，但是也有不少的用户在自有网站项目中正式使用起来。</p>

<h4 id="步骤如下">步骤如下：</h4>

<p><strong>第一、安装Let&rsquo;s Encrypt前的准备工作</strong></p>

<pre><code class="language-bash">#检查系统是否安装git
git  --version 
#git 安装
yum install git
#查看python版本,尽量保证在2.7以上
python -v 
</code></pre>

<p><strong>第二、获取Let&rsquo;s Encrypt免费SSL证书</strong>
//当时配置的时候,碰到好多错误,还好网上都有了解决办法,大家出错的时候可以看看letsencrypt下面的日志,里面报错内容都有,把错误尽量都解决了,再安装,不然错一次申请一次证书,次数用完,就要在等一周才能申请了.</p>

<pre><code class="language-bash">#获取letsencrypt
git clone https://github.com/letsencrypt/letsencrypt
#进入letsencrypt目录
cd letsencrypt
#生成证书1
//可以填两个域名，也可以填一个
./letsencrypt-auto certonly --standalone --email your_email@address -d your_url_address -d www.your_url_address

#生成证书2
//我一般用这个
./letsencrypt-auto
1. 填入邮箱地址
2. 选择A
3. 选择Y
4. 填入域名地址    //多域名用空格或者/或者,隔开
</code></pre>

<p><strong>第三、Let&rsquo;s Encrypt免费SSL证书获取与应用</strong></p>

<p>在完成Let&rsquo;s Encrypt证书的生成之后，我们会在&rdquo;/etc/letsencrypt/live/your_url_address/&ldquo;域名目录下有4个文件就是生成的密钥证书文件。</p>

<p>cert.pem - Apache服务器端证书
chain.pem - Apache根证书和中继证书
fullchain.pem - Nginx所需要ssl_certificate文件
privkey.pem - 安全证书KEY文件</p>

<p>如果我们使用的Nginx环境，那就需要用到fullchain.pem和privkey.pem两个证书文件，在部署Nginx的时候需要用到。在Nginx环境中，只要将对应的ssl_certificate和ssl_certificate_key路径设置成我们生成的2个文件就可以。</p>

<pre><code class="language-bash">#打开linux配置文件，找到HTTPS 443端口配置的server,如果有以下文件就不需要再添加了，没有的话就添加上
 ssl_certificate /etc/letsencrypt/live/your_url_address/fullchain.pem;
 ssl_certificate_key /etc/letsencrypt/live/your_url_address/privkey.pem;
</code></pre>

<p><strong>第四、解决Let&rsquo;s Encrypt免费SSL证书有效期问题</strong></p>

<p>Let&rsquo;s Encrypt证书是有效期90天的，需要我们自己手工更新续期才可以。
手工续期命令如下：_</p>

<pre><code class="language-bash">./letsencrypt-auto certonly --renew-by-default --email your_email@address -d your_url_address -d www.your_url_address
</code></pre>

<p>这样我们就可以续期,当然我们也可以写一个<code>cron</code>脚本让他自动续期</p>

<h3 id="从证书中删除域名">从证书中删除域名</h3>

<p>Let’s Encrypt目前并不提供从证书中删除域名的功能,所以我们只是把证书删除后重新申请.
&gt; 证书每周申请数量有限,不要一直删了申请</p>

<p>删除证书的时候，需要删除archive中的文件和live中的符号链接，同时还需要删除证书更新的配置文件：</p>

<pre><code class="language-bash">rm -rf /etc/letsencrypt/live/www.example.com/
rm -rf /etc/letsencrypt/archive/www.example.com/
rm /etc/letsencrypt/renewal/www.example.com.conf
</code></pre>

<p>删除后，重新申请证书，这里给出的是webroot方式，当然你也可以用上面的方法:</p>

<pre><code class="language-bash">letsencrypt certonly --webroot -w /var/www/example -d your_url_address -d www.your_url_address
</code></pre>

<h1 id="自动续期脚本">自动续期脚本</h1>

<pre><code class="language-bash">//这个脚本放在和let's encrypt目录同级的目录下
#!/bin/sh
# This script renews all the Let's Encrypt certificates with a validity &lt; 30 days

if ! /opt/letsencrypt/letsencrypt-auto renew &gt; /var/log/letsencrypt/renew.log 2&gt;&amp;1 ; then
    echo Automated renewal failed:
    cat /var/log/letsencrypt/renew.log
    exit 1
fi
</code></pre>

<p><strong>权限</strong></p>

<pre><code class="language-bash">chmod +x renewCerts.sh
</code></pre>

<p><strong>cron脚本</strong></p>

<pre><code class="language-bash">//每个月凌晨1点运行
0 0 1 * * /bin/sh /opt/renewCerts.sh
</code></pre>

<h1 id="坑">坑：</h1>

<ul>
<li>每周申请次数有限</li>
<li>国内服务器要放行443端口,然后重启服务器,不然访问不到,(当时国外两个服务器很快就配置好了,国内服务器一直出错出错,后来问了几个表哥,原来是阿里云要放行一下443端口.)</li>
<li>如果用以上第二种方法申请,nginx服务器默认的配置在删除证书文件后还存在.</li>
</ul>
          
				</article>
			</div>
			<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
		</div>
    <div class="uk-grid">
      <div class="uk-width-large-1-10"></div>
      <div class="uk-width-large-8-10">
        <ul class="uk-pagination">
          
            <li class="uk-float-left"><a href="http://mu1er.github.io/post/2018-2-9-go%E8%AF%AD%E8%A8%80%E6%89%AB%E6%8F%8F%E7%A1%AC%E7%9B%98%E6%9F%A5%E6%89%BE%E8%87%AA%E5%B7%B1%E9%9C%80%E8%A6%81%E7%9A%84%E6%96%87%E4%BB%B6/">&lt; Previous</a></li>
          
          
            <li class="uk-float-right"><a href="http://mu1er.github.io/post/2018-2-13-gravatar%E4%B8%BA%E7%94%A8%E6%88%B7%E9%9A%8F%E6%9C%BA%E7%94%9F%E6%88%90%E5%A4%B4%E5%83%8F/">Next &gt;</a></li>
          
        </ul>
      </div>
      <div class="uk-width-large-1-10"></div>
    </div>
    <div class="uk-grid">
      <div class="uk-width-large-1-10"></div>
      <div class="uk-width-large-8-10">
        <div class="uk-panel uk-panel-box uk-panel-box-secondary">
          <h3 class="uk-panel-title">Related Posts</h3>
          
          
          <ul class="uk-list uk-list-striped">
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
          </ul>
        </div>
      </div>
      <div class="uk-width-large-1-10"></div>
    </div>
    <div class="uk-grid">
      <div class="uk-width-large-1-10"></div>
      <div class="uk-width-large-8-10">
        <div id="disqus_thread" data-uk-scrollspy></div>
      </div>
      <div class="uk-width-large-1-10"></div>
    </div>
	</div>
</div>

	<div id="footer" class="uk-block uk-block-large uk-block-muted" data-uk-scrollspy="{repeat: true, delay: 600}">
		<div class="uk-container uk-container-center">
			<div class="uk-grid">
				<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
				<div class="uk-width-large-8-10 uk-width-medium-1-1 uk-width-small-1-1">
                  <div class="uk-grid">
                    <div class="uk-width-1-1">
                      &copy; Copyright -2019  Auuu Nya
                    </div>
                    <div class="uk-width-1-1">
                      Powered by <a href="http://gohugo.io">Hugo</a> | Themed by <a href="https://github.com/leopku/hugo-theme-next">NeXT</a>
                    </div>
                  </div>

				</div>
				<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
			</div>
		</div>
	</div>

	<script src="//cdn.jsdelivr.net/jquery/1.11.3/jquery.min.js"></script>
	<script src="//cdn.jsdelivr.net/uikit/2.27.2/js/uikit.min.js"></script>
	<script src="//cdn.jsdelivr.net/highlight.js/9.10.0/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>






</body>
</html>



